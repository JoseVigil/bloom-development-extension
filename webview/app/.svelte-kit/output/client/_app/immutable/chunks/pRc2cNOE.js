import{z as C}from"./OFsEVZk6.js";let r=null,s=null,i=null,a=new Map;const f={connected:!1,reconnecting:!1,activeContext:null,activeIntentId:null,streaming:!1,chunks:[]};function E(){const{subscribe:g,set:u,update:l}=C(f);function d(n="ws://localhost:4124"){if(!(r&&r.readyState===WebSocket.OPEN)){l(e=>({...e,reconnecting:!0}));try{r=new WebSocket(n),r.onopen=()=>{console.log("[WS] Connected"),u({...f,connected:!0,reconnecting:!1}),s&&(clearTimeout(s),s=null)},r.onmessage=e=>{try{const o=JSON.parse(e.data);k(o)}catch(o){console.error("[WS] Parse error:",o)}},r.onerror=e=>{console.error("[WS] Error:",e)},r.onclose=()=>{console.log("[WS] Disconnected"),l(e=>({...e,connected:!1,reconnecting:!1})),r=null,p(n)}}catch(e){console.error("[WS] Connection error:",e),l(o=>({...o,connected:!1,reconnecting:!1})),p(n)}}}function p(n){s||(s=window.setTimeout(()=>{s=null,d(n)},3e3))}function k(n){const{event:e,data:o}=n;if((e==="btip:updated"||e==="intents:updated")&&i&&i(),e==="profile:update"){const c=a.get("profile:update");c&&c.forEach(t=>t(o))}if(e==="host_event"){const c=a.get("host_event");c&&c.forEach(t=>t(o))}if(e==="copilot.stream_start"){l(t=>({...t,streaming:!0,chunks:[],activeContext:o.context,activeIntentId:o.intentId||null}));const c=a.get("copilot.stream_start");c&&c.forEach(t=>t(o))}if(e==="copilot.stream_chunk"){l(t=>({...t,chunks:[...t.chunks,o.chunk]}));const c=a.get("copilot.stream_chunk");c&&c.forEach(t=>t(o))}if(e==="copilot.stream_end"){l(t=>({...t,streaming:!1}));const c=a.get("copilot.stream_end");c&&c.forEach(t=>t(o))}if(e==="copilot.error"){l(t=>({...t,streaming:!1}));const c=a.get("copilot.error");c&&c.forEach(t=>t(o))}}function m(){s&&(clearTimeout(s),s=null),r&&(r.close(),r=null),u(f)}function h(n,e){return!r||r.readyState!==WebSocket.OPEN?(console.error("[WS] Cannot send, not connected"),!1):(r.send(JSON.stringify({event:n,data:e})),!0)}function b(n,e,o){return h("copilot.prompt",{context:n,text:e,intentId:o})}function S(n){i=n}function W(n,e){a.has(n)||a.set(n,[]),a.get(n).push(e)}function w(){l(n=>({...n,chunks:[]}))}return{subscribe:g,connect:d,disconnect:m,send:h,sendCopilotPrompt:b,onUpdate:S,on:W,clearChunks:w}}const v=E();export{v as w};
