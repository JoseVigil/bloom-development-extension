import{p as h,w,q as l}from"./svelte.js";import{g as c}from"./client.js";const p="btip_onboarding";function d(){return typeof window<"u"&&window.api!==void 0}async function f(){if(typeof window>"u")return{};try{if(d()&&window.api?.invoke){const i=await window.api.invoke("onboarding:status");if(i.success)return{completed:i.completed,...i.steps}}const n=localStorage.getItem(p);return n?JSON.parse(n):{}}catch(n){return console.error("Error loading onboarding state:",n),{}}}function s(n){if(!(typeof window>"u"))try{localStorage.setItem(p,JSON.stringify({step:n.step,githubAuthenticated:n.githubAuthenticated,geminiConfigured:n.geminiConfigured,hasNucleus:n.hasNucleus,hasProjects:n.hasProjects,completed:n.completed}))}catch(i){console.error("Error saving to storage:",i)}}async function m(n){if(!(!d()||!window.api?.invoke))try{n.completed&&await window.api.invoke("onboarding:complete",{steps:{githubAuthenticated:n.githubAuthenticated,geminiConfigured:n.geminiConfigured,hasNucleus:n.hasNucleus,hasProjects:n.hasProjects}})}catch(i){console.error("Error syncing with Electron:",i)}}function y(){const n={step:"welcome",githubAuthenticated:!1,geminiConfigured:!1,hasNucleus:!1,hasProjects:!1,completed:!1,loading:!1,error:null},{subscribe:i,set:g,update:r}=w(n);return typeof window<"u"&&f().then(e=>{if(r(o=>({...o,...e})),l({subscribe:i}).completed&&typeof window<"u"){const o=window.location.pathname;(o==="/onboarding"||o==="/")&&c()}}),{subscribe:i,async init(){r(e=>({...e,loading:!0,error:null}));try{const e=await f();r(t=>({...t,...e,loading:!1}))}catch(e){r(t=>({...t,loading:!1,error:e instanceof Error?e.message:"Failed to initialize"}))}},async checkAuth(){try{const t=await(await fetch("/api/auth/status")).json();r(o=>{const a={...o,githubAuthenticated:t.githubAuthenticated||!1,geminiConfigured:t.geminiConfigured||!1};return s(a),a})}catch(e){console.error("Failed to check auth:",e),r(t=>({...t,error:"Failed to check authentication status"}))}},async checkNucleus(){try{const t=await(await fetch("/api/nucleus/list")).json();r(o=>{const a={...o,hasNucleus:(t.nuclei?.length||0)>0};return s(a),a})}catch(e){console.error("Failed to check nucleus:",e)}},async checkProjects(){try{const t=await(await fetch("/api/projects/list")).json();r(o=>{const a={...o,hasProjects:(t.projects?.length||0)>0};return s(a),a})}catch(e){console.error("Failed to check projects:",e)}},setStep(e){r(t=>{const o={...t,step:e};return s(o),o})},nextStep(){r(e=>{let t=e.step;e.step==="welcome"&&e.githubAuthenticated?t="gemini":e.step==="gemini"&&e.geminiConfigured?t="nucleus":e.step==="nucleus"&&e.hasNucleus&&(t="projects");const o={...e,step:t};return s(o),o})},async complete(){r(t=>{const o={...t,completed:!0,loading:!0};return s(o),o});const e=l({subscribe:i});await m(e),r(t=>({...t,loading:!1})),typeof window<"u"&&c()},async reset(){const e={step:"welcome",githubAuthenticated:!1,geminiConfigured:!1,hasNucleus:!1,hasProjects:!1,completed:!1,loading:!1,error:null};if(g(e),s(e),d()&&window.api?.invoke)try{await window.api.invoke("onboarding:reset")}catch(t){console.error("Error resetting onboarding in Electron:",t)}typeof window<"u"&&c()}}}const u=y();h(u,n=>!n.completed);typeof window<"u"&&window.api?.on&&(window.api.on("onboarding:completed",()=>{u.complete()}),window.api.on("show-onboarding",()=>{u.reset()}));export{u as o};
