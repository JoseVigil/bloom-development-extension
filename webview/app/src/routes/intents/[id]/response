<script lang="ts">
  import { page } from '$app/stores';
  import { onMount } from 'svelte';
  import { goto } from '$app/navigation';
  import { ArrowLeft, Check, X } from 'lucide-svelte';
  
  $: intentId = $page.params.id;
  let operations: any[] = [];
  let loading = true;
  
  onMount(async () => {
    // Load operations/diffs from plugin
    loading = false;
  });
  
  function acceptHunk(opId: string, hunkId: string) {
    console.log('Accept hunk:', opId, hunkId);
  }
  
  function rejectHunk(opId: string, hunkId: string) {
    console.log('Reject hunk:', opId, hunkId);
  }
  
  async function finalizeResponse() {
    // Create new turn with accepted changes
    goto(`/intents/${intentId}`);
  }
</script>

<div class="response-view">
  <header class="response-header">
    <button on:click={() => goto(`/intents/${intentId}`)} class="back-btn">
      <ArrowLeft size={20} />
      Back to Intent
    </button>
    <h2>Review Response</h2>
    <button on:click={finalizeResponse} class="btn-primary">
      Finalize & Continue
    </button>
  </header>

  <div class="response-content">
    {#if loading}
      <div class="loading">Loading operations...</div>
    {:else if operations.length === 0}
      <div class="empty">No operations to review</div>
    {:else}
      {#each operations as op}
        <div class="operation">
          <h3>{op.type}: {op.file}</h3>
          {#each op.hunks as hunk}
            <div class="hunk">
              <pre class="diff">{hunk.content}</pre>
              <div class="hunk-actions">
                <button on:click={() => acceptHunk(op.id, hunk.id)} class="btn-accept">
                  <Check size={16} /> Accept
                </button>
                <button on:click={() => rejectHunk(op.id, hunk.id)} class="btn-reject">
                  <X size={16} /> Reject
                </button>
              </div>
            </div>
          {/each}
        </div>
      {/each}
    {/if}
  </div>
</div>

<style>
  .response-view {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .response-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
  }

  .back-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: transparent;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
  }

  .back-btn:hover {
    background: var(--bg-tertiary);
  }

  h2 {
    margin: 0;
    font-size: 1.25rem;
    flex: 1;
    text-align: center;
  }

  .btn-primary {
    padding: 0.5rem 1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .response-content {
    flex: 1;
    overflow: auto;
    padding: 1.5rem;
  }

  .loading, .empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
  }

  .operation {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .operation h3 {
    margin: 0 0 1rem;
    font-size: 1rem;
  }

  .hunk {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .diff {
    margin: 0 0 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    overflow-x: auto;
  }

  .hunk-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-accept, .btn-reject {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border: none;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .btn-accept {
    background: #10b981;
    color: white;
  }

  .btn-reject {
    background: #ef4444;
    color: white;
  }
</style>