<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CSP Corregido para evitar warning y permitir scripts locales -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' http://localhost:* ws://localhost:*;">
  <title>Bloom Nucleus Installer</title>
  <style>
    /* ESTILOS BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333; overflow: hidden;
    }
    .container { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
    
    /* PANTALLAS */
    .screen {
      display: none; flex: 1; flex-direction: column;
      justify-content: center; align-items: center; padding: 40px;
      animation: fadeIn 0.3s ease-in;
    }
    .screen.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* TARJETAS */
    .card {
      background: white; border-radius: 20px; padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto;
    }
    
    /* COMPONENTES UI */
    .logo {
      width: 80px; height: 80px; margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px; display: flex; align-items: center; justify-content: center;
      font-size: 40px; color: white; font-weight: bold;
    }
    h1 { font-size: 28px; margin-bottom: 15px; color: #2d3748; text-align: center; }
    p { color: #718096; line-height: 1.6; margin-bottom: 20px; }
    
    .info-box { background: #f7fafc; border-left: 4px solid #667eea; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .warning-box { background: #fffaf0; border-left: 4px solid #ed8936; padding: 15px; margin: 15px 0; border-radius: 5px; color: #744210; }
    .success-box { background: #f0fff4; border-left: 4px solid #48bb78; padding: 15px; margin: 15px 0; border-radius: 5px; }
    
    code { background: #e2e8f0; padding: 2px 6px; border-radius: 3px; font-size: 13px; color: #2d3748; word-break: break-all; }
    
    /* BOTONES */
    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 14px 35px; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s; margin: 10px 5px;
    }
    .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
    .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background: #cbd5e0; }
    .button-secondary { background: #e2e8f0; color: #4a5568; }
    .button-group { display: flex; gap: 10px; justify-content: center; margin-top: 25px; flex-wrap: wrap; }

    /* PROGRESO Y SPINNERS */
    .progress-container { width: 100%; margin: 30px 0; }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; width: 0%; }
    .progress-text { color: #4a5568; font-size: 14px; text-align: center; }
    
    .spinner {
      width: 40px; height: 40px; border: 4px solid #e2e8f0;
      border-top-color: #667eea; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 20px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* STATUS ICONS */
    .success-icon, .error-icon {
      width: 70px; height: 70px; margin: 0 auto 25px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 40px; color: white;
    }
    .success-icon { background: #48bb78; }
    .error-icon { background: #f56565; }

    /* PROFILE LIST */
    .profile-list { margin: 20px 0; max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    .profile-item { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; }
    .profile-item:hover { background: #f7fafc; }
    .profile-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; }

    /* ANIMACIONES HANDSHAKE */
    .status-dot { width: 20px; height: 20px; border-radius: 50%; margin: 0 auto; transition: background 0.3s; }
    .status-dot.red { background: #f56565; box-shadow: 0 0 10px #f56565; }
    .status-dot.green { background: #48bb78; box-shadow: 0 0 10px #48bb78; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- 1. WELCOME SCREEN -->
    <div class="screen active" id="welcome-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Bloom Nucleus Installer</h1>
        <p class="text-center">
          Este instalador configurar√° el sistema completo de Bloom Nucleus en tu m√°quina:
          Servicio de Background, Motor Python y Extensi√≥n de Chrome.
        </p>
        
        <div class="info-box">
          <strong>Ubicaci√≥n de instalaci√≥n:</strong>
          <code id="install-path">Cargando...</code>
        </div>

        <div class="warning-box">
          ‚ö†Ô∏è Requiere permisos de administrador.
        </div>

        <div class="button-group">
          <!-- Disabled by default until init() completes -->
          <button class="button" id="start-button" disabled>Cargando sistema...</button>
        </div>
      </div>
    </div>

    <!-- 2. INSTALLATION SCREEN -->
    <div class="screen" id="installation-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Instalando Bloom Nucleus</h1>
        <p class="text-center">Por favor espera mientras se configura el entorno...</p>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-text" id="progress-text">Iniciando...</div>
        </div>
        <div class="spinner"></div>
      </div>
    </div>

    <!-- 3. SERVICE CONFIGURATION SCREEN -->
    <div class="screen" id="service-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Configurando Servicio</h1>
        
        <div id="service-status-container" style="text-align: center;">
          <div class="spinner"></div>
          <p id="service-status-text" style="margin-top: 20px; color: #4a5568;">Instalando servicio...</p>
        </div>

        <div id="service-result" style="display: none;">
          <div class="success-box">
            <strong>‚úì Servicio instalado correctamente</strong>
            Puerto: <code id="detected-port">5678</code>
          </div>
          <div class="button-group">
            <button class="button" id="continue-from-service-btn">Continuar</button>
          </div>
        </div>

        <div id="service-error" style="display: none;">
          <div class="warning-box">
            <strong>‚ö†Ô∏è Error al instalar el servicio</strong>
            <p id="service-error-text"></p>
          </div>
          <div class="button-group">
            <button class="button button-secondary" id="retry-service-btn">Reintentar</button>
            <button class="button" id="skip-service-btn">Continuar sin servicio</button>
          </div>
        </div>
      </div>  
    </div>

    <!-- MANUAL INSTALLATION SCREEN -->
    <div class="screen" id="manual-install-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Instalaci√≥n de Extensi√≥n</h1>
        
        <div class="info-box" style="text-align: left; background: #ebf8ff; border-left-color: #4299e1;">
          <strong>üìã Instrucciones:</strong>
          <ol style="margin: 15px 0 0 20px; line-height: 2.2; font-size: 15px;">
            <li>Abre <strong>Chrome</strong> (cualquier perfil)</li>
            <li>Ve a <code style="background: white; padding: 4px 8px;">chrome://extensions/</code></li>
            <li>Activa <strong>"Modo de desarrollador"</strong> (toggle arriba a la derecha)</li>
            <li>Arrastra el archivo <code style="background: white; padding: 4px 8px;">extension.crx</code> a la ventana</li>
            <li>Haz clic en <strong>"Agregar extensi√≥n"</strong></li>
          </ol>
        </div>

        <div class="button-group">
          <button class="button" id="open-crx-folder-btn">
            üìÅ Abrir Carpeta con CRX
          </button>
          <button class="button button-secondary" id="open-chrome-ext-btn">
            üåê Abrir chrome://extensions/
          </button>
        </div>

        <div style="margin-top: 40px; padding: 25px; background: #f0fff4; border-radius: 10px; border-left: 4px solid #48bb78;">
          <p style="font-size: 14px; color: #2f855a; margin-bottom: 15px; font-weight: 600;">
            ‚è±Ô∏è Esperando instalaci√≥n...
          </p>
          <p style="font-size: 13px; color: #4a5568; margin-bottom: 20px;">
            El instalador detectar√° autom√°ticamente cuando instales la extensi√≥n.
          </p>
          <div class="spinner" style="margin: 20px auto;"></div>
          <p id="heartbeat-status" style="font-size: 12px; color: #718096; text-align: center;">
            Verificando conexi√≥n...
          </p>
        </div>
      </div>
    </div>

    <!-- 5. HANDSHAKE SCREEN -->
    <div class="screen" id="handshake-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1 id="handshake-title">Configurando...</h1>
        
        <div id="handshake-steps">
            <!-- Paso 1: Instalando (ID: step-installing) -->
            <div id="step-installing" style="text-align: center;">
                <div class="spinner"></div>
                <p>Aplicando configuraci√≥n Enterprise...</p>
            </div>

            <!-- Paso 2: Esperando a Chrome (ID: step-waiting-chrome) -->
            <div id="step-waiting-chrome" style="display: none; text-align: center;">
                <div class="info-box" style="background: #ebf8ff; border-left-color: #4299e1;">
                    <strong>Sincronizando...</strong>
                    <div id="step2-message">Validando conexi√≥n con Chrome...</div>
                </div>
                
                <div style="margin: 30px 0;">
                    <div class="status-dot red" id="heartbeat-dot"></div>
                    <p style="margin-top: 10px; font-size: 14px; color: #718096;">Esperando se√±al del sistema...</p>
                </div>
            </div>
            
            <!-- Paso 3: √âxito (ID: step-success) -->
            <div id="step-success" style="display: none; text-align: center;">
                <div class="success-icon" style="transform: scale(1.5); margin: 40px auto;">‚úì</div>
                <h2 style="color: #48bb78; margin-bottom: 20px;">¬°Conectado!</h2>
                <p>Sistema sincronizado correctamente.</p>
                
                <div class="button-group">
                  <button class="button" id="finish-handshake-btn">Finalizar</button>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- 6. SUCCESS SCREEN -->    
    <div class="screen" id="success-screen">
      <div class="card">
        <div class="success-icon">‚úì</div>
        <h1>¬°Instalaci√≥n Completa!</h1>
        <p class="text-center">Bloom Nucleus ha sido configurado correctamente.</p>

        <div class="success-box">
          <strong>Estado del Sistema:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Servicio Host: <strong>Activo</strong> (Puerto <span id="final-port">...</span>)</li>
            <li>Extensi√≥n Chrome: <strong>Instalada</strong></li>
            <li>Motor IA: <strong>Listo</strong></li>
          </ul>
        </div>

        <!-- Instrucci√≥n de desarrollo -->
        <div class="info-box" style="background: #fffaf0; border-left-color: #ed8936; text-align: left;">
          <strong>üõ†Ô∏è Modo Desarrollo - Siguiente Paso:</strong>
          <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
            <li>Abre VSCode en la carpeta <code>vscode-extension</code></li>
            <li>Presiona <strong>F5</strong> para iniciar debug</li>
            <li>Espera a que cargue (aparecer√° nueva ventana VSCode)</li>
            <li>Vuelve aqu√≠ y haz clic en <strong>"Configurar Bloom"</strong></li>
          </ol>
          <p style="margin-top: 10px; font-size: 13px; color: #744210;">
            üí° El instalador verificar√° autom√°ticamente que el servidor est√© corriendo.
          </p>
        </div>

        <div class="button-group" id="final-actions">
          <button class="button button-secondary" id="final-view-logs-btn">Ver Logs</button>
          <button class="button" id="open-onboarding-btn">üöÄ Configurar Bloom</button>
        </div>
      </div>
    </div>

    <!-- 7. ERROR SCREEN -->
    <div class="screen" id="error-screen">
      <div class="card">
        <div class="error-icon">‚úï</div>
        <h1>Error en la Instalaci√≥n</h1>
        <p class="text-center" id="error-message">Ha ocurrido un error.</p>
        <div class="button-group">
          <button class="button" id="retry-button">Reintentar</button>
        </div>
      </div>
    </div>

  </div>

  <script>

    let systemInfo = null;
    let servicePort = 5678;
    let handshakeInterval = null;
    let installedExtensionPath = null;
    let isInstallationInProgress = false; 
    let selectedProfileId = null;

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    async function init() {
      try {
        if (!window.api) throw new Error("API not loaded");
        
        systemInfo = await window.api.getSystemInfo();
        
        // Update UI
        document.getElementById('install-path').textContent = systemInfo.paths.hostInstallDir;
        
        // Enable start button only after info is loaded
        const startBtn = document.getElementById('start-button');
        startBtn.textContent = "Comenzar Instalaci√≥n";
        startBtn.disabled = false;

        // Setup Listeners
        setupGlobalListeners();
        
      } catch (e) {
        console.error("Init failed:", e);
        document.getElementById('start-button').textContent = "Error de carga";
      }
    }

    function setupGlobalListeners() {
      // Listener para progreso
      window.api.onInstallationProgress((data) => {
        const percentage = (data.step / data.total) * 100;
        document.getElementById('progress-fill').style.width = percentage + '%';
        document.getElementById('progress-text').textContent = 
          `Paso ${data.step}/${data.total}: ${data.message}`;
      });

      // Listener para estado de servidor (Configurar Bloom)
      window.api.onServerStatus((data) => {
        const btn = document.getElementById('open-onboarding-btn');
        if(btn && data.status === 'checking') {
          btn.textContent = 'Verificando...';
        }
      });
    }

    // ========================================================================
    // NAVIGATION
    // ========================================================================

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // ========================================================================
    // LOGIC
    // ========================================================================

    // 1. WELCOME -> INSTALL
    document.getElementById('start-button').addEventListener('click', async () => {
      showScreen('installation-screen');
      const result = await window.api.startInstallation({ devMode: true });
      
      if (result.success) {
        showScreen('service-screen');
        await installService();
      } else {
        showError(result.error);
      }
    });

    // 2. INSTALL SERVICE
    async function installService() {
      if (!systemInfo) return; // Guard clause

      // Check VC++ (Windows Only)
      if (systemInfo.platform === 'win32') {
        const preflight = await window.api.preflightChecks();
        if (!preflight.vcRedistInstalled) {
            document.getElementById('service-status-text').textContent = 'Instalando dependencias VC++...';
            await window.api.installVCRedist();
        }
      }

      document.getElementById('service-status-text').textContent = 'Iniciando servicio...';
      const result = await window.api.installService();

      if (result.success) {
        servicePort = result.port;
        document.getElementById('detected-port').textContent = result.port;
        document.getElementById('service-status-container').style.display = 'none';
        document.getElementById('service-result').style.display = 'block';
      } else {
        document.getElementById('service-error-text').textContent = result.error;
        document.getElementById('service-status-container').style.display = 'none';
        document.getElementById('service-error').style.display = 'block';
      }
    }

    // Despu√©s de instalar servicio exitosamente
    document.getElementById('continue-from-service-btn').addEventListener('click', async () => {
      showScreen('manual-install-screen');
      
      // Instalar extensi√≥n (solo provisiona archivos)
      const result = await window.api.installExtension();
      
      if (!result.success) {
        showError(result.error);
        return;
      }
      
      console.log('‚úÖ Extensi√≥n provisionada:', result);
      
      // Iniciar polling autom√°tico
      startHeartbeatPolling();
    });

    // Botones de ayuda
    document.getElementById('open-crx-folder-btn').addEventListener('click', async () => {
      await window.api.openFolder(systemInfo.paths.hostInstallDir);
    });

    document.getElementById('open-chrome-ext-btn').addEventListener('click', async () => {
      await window.api.openChromeExtensions();
    });

    // Polling de conexi√≥n
    let heartbeatInterval = null;
    let heartbeatAttempts = 0;
    const MAX_ATTEMPTS = 45; // 90 segundos (45 x 2s)

    function startHeartbeatPolling() {
      console.log('üîÑ Iniciando polling de heartbeat...');
      
      heartbeatInterval = setInterval(async () => {
        heartbeatAttempts++;
        
        // Update UI
        document.getElementById('heartbeat-status').textContent = 
          `Intento ${heartbeatAttempts}/${MAX_ATTEMPTS} - Esperando se√±al de Chrome...`;
        
        // Check connection
        const status = await window.api.checkExtensionHeartbeat();
        
        if (status.chromeConnected) {
          console.log('‚úÖ ¬°Conexi√≥n detectada!');
          clearInterval(heartbeatInterval);
          onExtensionConnected();
          return;
        }
        
        // Timeout
        if (heartbeatAttempts >= MAX_ATTEMPTS) {
          clearInterval(heartbeatInterval);
          showError('Timeout: La extensi√≥n no se conect√≥ en 90 segundos.\n\n' +
                    'Verifica que:\n' +
                    '1. Instalaste la extensi√≥n en Chrome\n' +
                    '2. La extensi√≥n est√° habilitada\n' +
                    '3. El servicio est√° corriendo');
        }
      }, 2000);
    }

    function onExtensionConnected() {
      // Mostrar √©xito
      document.getElementById('final-port').textContent = servicePort;
      showScreen('success-screen');
      
      console.log('üéâ Instalaci√≥n completada exitosamente');
    }
    
    document.getElementById('retry-service-btn').addEventListener('click', installService);
    document.getElementById('skip-service-btn').addEventListener('click', () => {
      showScreen('profiles-screen');
      loadChromeProfiles();
    });

    // 3. PROFILES SCREEN
    async function loadChromeProfiles() {
      const list = document.getElementById('profile-list');
      list.innerHTML = '<div class="spinner"></div>';
      
      // Ocultar checkbox de "Seleccionar todos" si existe, ya no aplica
      const selectAllContainer = document.querySelector('.input-group');
      if (selectAllContainer) selectAllContainer.style.display = 'none';

      const result = await window.api.getChromeProfiles();
      
      if (result.success) {
        document.getElementById('chrome-running-warning').style.display = 
          result.isChromeRunning ? 'block' : 'none';
        
        list.innerHTML = '';
        if (result.profiles.length === 0) {
           list.innerHTML = '<p class="text-center">Perfil Predeterminado</p>';
        }

        result.profiles.forEach((p, index) => {
          const div = document.createElement('div');
          div.className = 'profile-item';
          // USAMOS RADIO BUTTON PARA SELECCI√ìN √öNICA
          // Seleccionamos el primero autom√°ticamente
          const checked = index === 0 ? 'checked' : '';
          
          div.innerHTML = `
            <input type="radio" name="chrome-profile" id="p-${p.id}" value="${p.id}" ${checked}>
            <label for="p-${p.id}" style="width: 100%; cursor: pointer;">
              <div style="font-weight:600">${p.name}</div>
              <div style="font-size:12px;color:#a0aec0">${p.id}</div>
            </label>
          `;
          list.appendChild(div);
        });
      }
    }

    
    // ========================================================================
    // 4. INSTALL EXTENSION & HANDSHAKE (L√≥gica Enterprise Corregida)
    // ========================================================================
    const installBtn = document.getElementById('install-extension-btn');

    installBtn.onclick = async () => {
      const selectedRadio = document.querySelector('input[name="chrome-profile"]:checked');
      
      if (!selectedRadio) {
          alert("Por favor selecciona un perfil de la lista.");
          return;
      }
      
      const targetProfileId = selectedRadio.value;
      console.log("üéØ PERFIL SELECCIONADO:", targetProfileId);

      if (installBtn.disabled) return;
      installBtn.disabled = true;
      installBtn.textContent = "Procesando...";
      
      showScreen('handshake-screen');
      
      document.getElementById('step-installing').style.display = 'block';
      document.getElementById('step-waiting-chrome').style.display = 'none';
      document.getElementById('step-success').style.display = 'none';

      try {
          // PASO 1: Registrar en Windows
          const res = await window.api.installExtensionSelected({ profiles: [targetProfileId] });
          
          if (!res.success) {
              throw new Error(res.error);
          }

          const installedPath = res.extensionId.path;
          console.log("‚úÖ Registro completado. Path:", installedPath);

          // PASO 2: UI Update
          document.getElementById('step-installing').style.display = 'none';
          document.getElementById('step-waiting-chrome').style.display = 'block';
          
          document.getElementById('step2-message').innerHTML = 
              `<p>Abriendo Chrome en perfil: <strong>${targetProfileId}</strong></p>
                <p style="font-size: 12px; color: #718096; margin-top: 10px;">
                Este proceso puede tardar 10-15 segundos mientras Chrome lee el registro...
                </p>`;

          // PASO 3: Lanzar Chrome
          console.log(`üöÄ Lanzando Chrome. Perfil: ${targetProfileId}`);
          await window.api.launchChromeProfile({ 
              profileId: targetProfileId, 
              extensionPath: installedPath 
          });

          // ‚è±Ô∏è CR√çTICO: Esperar M√ÅS tiempo antes de empezar polling
          console.log('‚è≥ Esperando 8 segundos a que Chrome procese el registro...');
          await new Promise(r => setTimeout(r, 8000));

          // PASO 4: Iniciar polling M√ÅS LENTO
          startHandshakePolling();

      } catch (error) {
          console.error("‚ùå Error en flujo:", error);
          if (error.message && error.message.includes("curso")) return;

          showError(error.message || "Error desconocido durante la instalaci√≥n");
          installBtn.disabled = false;
          installBtn.textContent = "Reintentar";
      }
    };

    function startHandshakePolling() {
        const dot = document.getElementById('heartbeat-dot');
        let attempts = 0;
        const MAX_ATTEMPTS = 30; // 30 intentos x 3 segundos = 90 segundos total
        
        handshakeInterval = setInterval(async () => {
          attempts++;
          
          // Animaci√≥n visual
          dot.style.opacity = dot.style.opacity === '0.5' ? '1' : '0.5';
          
          // Update contador
          const messageEl = document.getElementById('step2-message');
          if (messageEl) {
              messageEl.innerHTML = `
                  <p>Validando conexi√≥n con Chrome...</p>
                  <p style="font-size: 12px; color: #a0aec0; margin-top: 5px;">
                  Intento ${attempts}/${MAX_ATTEMPTS}
                  </p>
              `;
          }
          
          const status = await window.api.checkExtensionHeartbeat();
          
          if (status.chromeConnected) {
            clearInterval(handshakeInterval);
            dot.classList.remove('red');
            dot.classList.add('green');
            document.getElementById('step-waiting-chrome').style.display = 'none';
            document.getElementById('step-success').style.display = 'block';
            document.getElementById('handshake-title').textContent = "Sincronizado";
            return;
          }
          
          // Timeout despu√©s de MAX_ATTEMPTS
          if (attempts >= MAX_ATTEMPTS) {
              clearInterval(handshakeInterval);
              showError(`Timeout: Chrome no respondi√≥ despu√©s de ${MAX_ATTEMPTS * 3} segundos. 
                        Verifica:\n
                        1. Chrome se cerr√≥ completamente antes de reabrir\n
                        2. El registro se aplic√≥ correctamente (ejecuta regedit como Admin)\n
                        3. No hay pol√≠ticas de dominio bloqueando extensiones`);
          }
        }, 3000); // Polling cada 3 segundos (m√°s lento = m√°s confiable)
      }

    document.getElementById('finish-handshake-btn').addEventListener('click', finalizeSetup);

    // 5. FINALIZE & SUCCESS
    async function finalizeSetup() {
       // Perform any final cleanup or config saving here
       const result = await window.api.finalizeSetup({ 
           extensionId: "kalbnicbomhpdljbnkfhmjnibfjeninc", // Or retrieve from memory
           profiles: [] 
       });

       if (result.success) {
         document.getElementById('final-port').textContent = servicePort;
         showScreen('success-screen');
       } else {
         showError(result.error);
       }
    }

    // Botones Finales (Listeners agregados aqu√≠ porque los elementos son est√°ticos)
    document.getElementById('final-view-logs-btn').addEventListener('click', () => {
      window.api.openLogsFolder();
    });

    document.getElementById('open-onboarding-btn').addEventListener('click', async () => {
      await window.api.openBTIPConfig();
      setTimeout(() => window.close(), 3000);
    });

    // 6. ERROR HANDLING
    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
      showScreen('error-screen');
    }

    document.getElementById('retry-button').addEventListener('click', () => {
      location.reload();
    });    

    // START
    init();

  </script>
</body>
</html>