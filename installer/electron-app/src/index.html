<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' http://localhost:* ws://localhost:*;">
  <title>Bloom Nucleus Installer</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    
    <!-- 1. WELCOME SCREEN -->
    <div class="screen active" id="welcome-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Bloom Nucleus Installer</h1>
        <p class="text-center">
          Este instalador configurar√° el sistema completo de Bloom Nucleus en tu m√°quina:
          Servicio de Background, Motor Python y Extensi√≥n de Chrome.
        </p>
        
        <div class="info-box">
          <strong>Ubicaci√≥n de instalaci√≥n:</strong>
          <code id="install-path">Cargando...</code>
        </div>

        <div class="info-box">
          ‚úÖ Instalaci√≥n local (No requiere permisos de administrador).
        </div>

        <div class="button-group">
          <button class="button" id="start-button" disabled>Cargando sistema...</button>
        </div>
      </div>
    </div>

    <!-- 2. INSTALLATION SCREEN -->
    <div class="screen" id="installation-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Instalando Bloom Nucleus</h1>
        <p class="text-center">Por favor espera mientras se configura el entorno...</p>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-text" id="progress-text">Iniciando...</div>
        </div>
        <div class="spinner"></div>
      </div>
    </div>

    <!-- 3. SERVICE CONFIGURATION SCREEN -->
    <div class="screen" id="service-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Configurando Servicio</h1>
        
        <div id="service-status-container" style="text-align: center;">
          <div class="spinner"></div>
          <p id="service-status-text" style="margin-top: 20px; color: #4a5568;">Instalando servicio...</p>
        </div>

        <div id="service-result" style="display: none;">
          <div class="success-box">
            <strong>‚úì Servicio instalado correctamente</strong>
            Puerto: <code id="detected-port">5678</code>
          </div>
          <div class="button-group">
            <button class="button" id="continue-from-service-btn">Continuar</button>
          </div>
        </div>

        <div id="service-error" style="display: none;">
          <div class="warning-box">
            <strong>‚ö†Ô∏è Error al instalar el servicio</strong>
            <p id="service-error-text"></p>
          </div>
          <div class="button-group">
            <button class="button button-secondary" id="retry-service-btn">Reintentar</button>
            <button class="button" id="skip-service-btn">Continuar sin servicio</button>
          </div>
        </div>
      </div>  
    </div>

    <!-- 4. MANUAL INSTALL SCREEN -->
    <div class="screen" id="manual-install-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1>Instalar Extensi√≥n</h1>
        
        <div style="margin: 30px 0; display: flex; flex-direction: column; align-items: center;">
          <p style="margin-bottom: 15px; color: #4a5568; text-align: center;">
            1. Haz <strong>clic abajo</strong> para abrir la carpeta, luego<br>
            arrastra el archivo hacia <strong>chrome://extensions</strong>
          </p>
          
          <!-- Se elimin√≥ draggable="true" y se cambi√≥ el icono a carpeta -->
          <div id="draggable-crx" class="file-icon-card" style="cursor: pointer;">
            <div style="font-size: 42px; line-height: 1;">üìÇ</div>
            <div style="text-align: left;">
              <div style="font-weight: 700; color: #2d3748; font-size: 15px;">Abrir Ubicaci√≥n</div>
              <div style="font-size: 11px; color: #718096;">Click para ver archivo</div>
            </div>
          </div>
        </div>

        <div class="info-box">
          <p>2. Pega el ID de la extensi√≥n:</p>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="extension-id-input" placeholder="ID de la extensi√≥n..." style="flex: 1; padding: 8px;">
            <button class="button" id="confirm-id-btn">Conectar</button>
          </div>
          <p id="id-error-msg" style="color: red; display: none;"></p>
        </div>

        <div class="button-group">
          <button class="button button-secondary" id="open-chrome-ext-btn-manual">
            Abrir Chrome Extensions
          </button>
        </div>
        
        <div id="manual-connection-status" style="display:none; text-align:center;">
          <p id="heartbeat-status">Sincronizando...</p>
        </div>
      </div>
    </div>

    <!-- 5. HANDSHAKE SCREEN -->
    <div class="screen" id="handshake-screen">
      <div class="card">
        <div class="logo">B</div>
        <h1 id="handshake-title">Configurando...</h1>
        
        <div id="handshake-steps">
          <div id="step-installing" style="text-align: center;">
            <div class="spinner"></div>
            <p>Aplicando configuraci√≥n Enterprise...</p>
          </div>

          <div id="step-waiting-chrome" style="display: none; text-align: center;">
            <div class="info-box" style="background: #ebf8ff; border-left-color: #4299e1;">
              <strong>Sincronizando...</strong>
              <div id="step2-message">Validando conexi√≥n con Chrome...</div>
            </div>
            
            <div style="margin: 30px 0;">
              <div class="status-dot red" id="heartbeat-dot"></div>
              <p style="margin-top: 10px; font-size: 14px; color: #718096;">Esperando se√±al del sistema...</p>
            </div>
          </div>
          
          <div id="step-success" style="display: none; text-align: center;">
            <div class="success-icon" style="transform: scale(1.5); margin: 40px auto;">‚úì</div>
            <h2 style="color: #48bb78; margin-bottom: 20px;">¬°Conectado!</h2>
            <p>Sistema sincronizado correctamente.</p>
            
            <div class="button-group">
              <button class="button" id="finish-handshake-btn">Finalizar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 6. SUCCESS SCREEN -->    
    <div class="screen" id="success-screen">
      <div class="card">
        <div class="success-icon">‚úì</div>
        <h1>¬°Instalaci√≥n Completa!</h1>
        <p class="text-center">Bloom Nucleus ha sido configurado correctamente.</p>

        <div class="success-box">
          <strong>Estado del Sistema:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Servicio Host: <strong>Activo</strong> (Puerto <span id="final-port">...</span>)</li>
            <li>Extensi√≥n Chrome: <strong>Instalada</strong></li>
            <li>Motor IA: <strong>Listo</strong></li>
          </ul>
        </div>

        <div class="info-box" style="background: #fffaf0; border-left-color: #ed8936; text-align: left;">
          <strong>üõ†Ô∏è Modo Desarrollo - Siguiente Paso:</strong>
          <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
            <li>Abre VSCode en la carpeta <code>vscode-extension</code></li>
            <li>Presiona <strong>F5</strong> para iniciar debug</li>
            <li>Espera a que cargue (aparecer√° nueva ventana VSCode)</li>
            <li>Vuelve aqu√≠ y haz clic en <strong>"Configurar Bloom"</strong></li>
          </ol>
          <p style="margin-top: 10px; font-size: 13px; color: #744210;">
            üí° El instalador verificar√° autom√°ticamente que el servidor est√© corriendo.
          </p>
        </div>

        <div class="button-group">
          <button class="button button-secondary" id="final-view-logs-btn">Ver Logs</button>
          <button class="button" id="open-onboarding-btn">üöÄ Configurar Bloom</button>
        </div>
      </div>
    </div>

    <!-- 7. ERROR SCREEN -->
    <div class="screen" id="error-screen">
      <div class="card">
        <div class="error-icon">‚úï</div>
        <h1>Error en la Instalaci√≥n</h1>
        <p class="text-center" id="error-message">Ha ocurrido un error.</p>
        <div class="button-group">
          <button class="button" id="retry-button">Reintentar</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module" src="./renderer.js"></script>
</body>
</html>